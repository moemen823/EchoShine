<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard |  EcoShine</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- AOS -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="icon" type="image/x-icon" href="./imgs/logo.png">

</head>

<body class="dashboard-bg">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold fs-4" href="index.html">
        <i class="bi bi-sun me-2 text-warning"></i> EcoShine
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav ms-auto text-center align-items-center" id="navLinks">
          <!-- These links will be replaced dynamically -->
          <li class="nav-item"><a class="nav-link active" href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="register.html">Register</a></li>
          <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
          <li class="nav-item"><a class="nav-link" href="booking.html">Book Cleaning</a></li>
          <li class="nav-item"><a class="nav-link active" id="dashboardLink" href="#">Dashboard</a></li>

        </ul>
      </div>
    </div>
  </nav>


  <!-- Dashboard Section -->
  <section class="dashboard-section py-5 mt-5 text-light">
    <div class="container" data-aos="fade-up">
      <div class="text-center mb-5">
        <h1 class="fw-bold text-warning"><i class="bi bi-speedometer2 me-2"></i>Admin Dashboard</h1>
        <p class="text-danger">Monitor your users, bookings, and cleaning progress ✨</p>
      </div>

      <!-- Stats Cards -->
      <div class="row g-4 mb-5">
        <div class="col-md-4">
          <div class="stat-card shadow-sm" data-aos="zoom-in" data-aos-delay="100">
            <i class="bi bi-people display-5 text-warning"></i>
            <h4 class="mt-3">Registered Users</h4>
            <p class="fs-3 fw-bold text-warning" id="userCount">24</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card shadow-sm" data-aos="zoom-in" data-aos-delay="200">
            <i class="bi bi-calendar-event display-5 text-warning"></i>
            <h4 class="mt-3">Upcoming Bookings</h4>
            <p class="fs-3 fw-bold text-warning" id="bookingCount">7</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stat-card shadow-sm" data-aos="zoom-in" data-aos-delay="300">
            <i class="bi bi-check-circle display-5 text-warning"></i>
            <h4 class="mt-3">Completed Cleanings</h4>
            <p class="fs-3 fw-bold text-warning" id="doneCount">42</p>
          </div>
        </div>
      </div>

      <!-- Table -->
      <div class="card glass-card p-4 rounded-4 shadow-lg" data-aos="fade-up">
        <h4 class="mb-3 text-warning"><i class="bi bi-list-ul me-2"></i>Recent Bookings</h4>
        <div class="table-responsive">
          <table class="table table-dark table-hover align-middle mb-0">
            <thead class="table-warning text-dark">
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Date</th>
                <th>Time</th>
                <th>Status</th>
                <th>Photo</th>
              </tr>
            </thead>
            <tbody id="bookingTable">


            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="py-4 bg-dark text-light text-center mt-5">
    <div class="container">
      <p class="mb-0">© <span id="year"></span>  EcoShine | Admin Dashboard</p>
    </div>
  </footer>

  <!-- JS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>

<script>
  AOS.init({ duration: 900, once: true });
  document.getElementById('year').textContent = new Date().getFullYear();
</script>

<!-- ✅ Firebase + Dashboard Logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBGSfwSqmK239i6CMP5mIItp_Xj-mwYV2I",
  authDomain: "solar-cleaning-website.firebaseapp.com",
  databaseURL: "https://solar-cleaning-website-default-rtdb.firebaseio.com",
  projectId: "solar-cleaning-website",
  storageBucket: "solar-cleaning-website.appspot.com",
  messagingSenderId: "454039844879",
  appId: "1:454039844879:web:8051aac69c8ac7baf50b7a",
  measurementId: "G-THCL9Q4WYX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// DOM elements
const table = document.getElementById("bookingTable");
const userCountElem = document.getElementById("userCount");
const bookingCountElem = document.getElementById("bookingCount");
const doneCountElem = document.getElementById("doneCount");

// ---------------- Fetch Bookings ----------------
onValue(ref(db, "bookings"), (snapshot) => {
  const data = snapshot.val() || {};
  table.innerHTML = "";

  // Initialize stats
  const uniqueUsers = new Set();
  let upcoming = 0;
  let completed = 0;
  let i = 1;

  for (const key in data) {
    const booking = data[key];

    // Collect statistics
    if (booking.username) uniqueUsers.add(booking.username);
    if (booking.status) completed++; else upcoming++;

    // Status badge
    const statusBadge = booking.status
      ? '<span class="badge bg-success">Completed</span>'
      : '<span class="badge bg-warning text-dark">Pending</span>';

    // Photo
    const photo = booking.panelPhoto
      ? `<img src="${booking.panelPhoto}" width="50" class="rounded" alt="panel">`
      : `<img src="https://via.placeholder.com/50" class="rounded" alt="panel">`;

    // Table row (send username!)
    
  // Table row (send bookingKey!)
table.insertAdjacentHTML("beforeend", `
  <tr style="cursor:pointer" 
    onclick="openClientDetails(
      '${key}',
      '${booking.username}',
      '${booking.name}',
      '${booking.date}',
      '${booking.time}',
      '${booking.status ? "Completed" : "Pending"}',
      '${booking.address}',
      '${booking.notes || ""}'
    )">
    <td>${i++}</td>
    <td>${booking.name}</td>
    <td>${booking.date}</td>
    <td>${booking.time}</td>
    <td>${statusBadge}</td>
    <td>${photo}</td>
  </tr>
`);

  }

  // Update dashboard stats
  userCountElem.textContent = uniqueUsers.size;
  bookingCountElem.textContent = upcoming;
  doneCountElem.textContent = completed;
});
</script>

<!-- ✅ Function to open client details -->
<script>
function openClientDetails(bookingKey, username, name, date, time, status, address, notes) {
  const url = new URL("client-details.html", window.location.origin);
  url.searchParams.set("key", bookingKey);
  url.searchParams.set("username", username);
  url.searchParams.set("name", name);
  url.searchParams.set("date", date);
  url.searchParams.set("time", time);
  url.searchParams.set("status", status);
  url.searchParams.set("address", address);
  url.searchParams.set("notes", notes);
  window.location.href = url.toString();
}
</script>


<!-- ✅ Navbar rebuild & logout -->
<script>
const navLinks = document.getElementById("navLinks");
const user = JSON.parse(localStorage.getItem("loggedUser"));

if (user) {
  // Profile image
  let imgSrc = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
  if (user.panelPhoto && user.panelPhoto.includes("drive.google")) {
    const match = user.panelPhoto.match(/[-\\w]{25,}/);
    if (match) imgSrc = `https://drive.google.com/uc?export=view&id=${match[0]}`;
  } else if (user.panelPhoto) {
    imgSrc = user.panelPhoto;
  }

  // Navbar structure
  navLinks.innerHTML = `
    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
    <li class="nav-item"><a class="nav-link" href="booking.html">Book Cleaning</a></li>
    <li class="nav-item"><a class="nav-link" href="My Bookings.html">My Book Cleaning</a></li>
 
 ${user.isAdmin ? `<li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>             <li class="nav-item"><a class="nav-link " href="messages.html">Client Messages</a></li>
   <li class="nav-item"><a class="nav-link " href="users managment.html">Manage Users</a></li>
` : ""} 
      <li class="nav-item"><a class="nav-link" href="about.html"">How are We</a></li>

<li class="nav-item dropdown ms-3">
      <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown"
        role="button" data-bs-toggle="dropdown" aria-expanded="false">
        <img src="${imgSrc}" alt="User" class="rounded-circle me-2"
          style="width:35px; height:35px; object-fit:cover;">
        <span class="fw-bold text-warning">${user.fullName.split(" ")[0]}</span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end shadow">
        <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item text-danger" href="#" id="logoutBtn">
          <i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
      </ul>
    </li>
  `;

  // Logout handler
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("loggedUser");
    window.location.href = "login.html";
  });
}
</script>



</body>

</html>