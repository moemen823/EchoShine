<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile |  EcoShine</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="./css/profile.css" />
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top bg-dark shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold fs-4" href="index.html">
        <i class="bi bi-sun me-2 text-warning"></i> EcoShine
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav ms-auto text-center align-items-center" id="navLinks">
          <li class="nav-item"><a class="nav-link " href="index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="booking.html">Book Cleaning</a></li>
          <li class="nav-item"><a class="nav-link" href="My Bookings.html">My Bookings</a></li>
          <li class="nav-item"><a class="nav-link" id="dashboardLink" href="dashboard.html">Dashboard</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Profile Section -->
  <section class="profile-section">
    <div class="profile-card p-4 shadow-lg text-center">
      <img id="profileImage" src="https://cdn-icons-png.flaticon.com/512/149/149071.png"
        class="rounded-circle mb-3 profile-img" alt="User Photo">

      <h3 id="displayName" class="text-warning fw-bold mb-1"></h3>
      <p class="text-secondary small mb-3">@<span id="usernameDisplay"></span></p>

      <div class="info-container text-start mx-auto" style="max-width: 400px;">
        <p><i class="bi bi-envelope-fill me-2"></i><strong>Email:</strong> <span id="displayEmail"></span></p>
        <p><i class="bi bi-telephone-fill me-2"></i><strong>Phone:</strong> <span id="displayPhone"></span></p>
        <p><i class="bi bi-geo-alt-fill me-2"></i><strong>Address:</strong> <span id="displayAddress"></span></p>
        <p><i class="bi bi-link-45deg me-2"></i><strong>Panel Photo:</strong> <a id="displayPhoto" href="#" target="_blank"
            class="text-info">View Photo</a></p>
      </div>

      <div class="mt-4">
        <button id="editToggle" class="btn btn-outline-warning px-4 me-2">
          <i class="bi bi-pencil-square me-1"></i> Edit
        </button>
        <button id="deleteBtn" class="btn btn-outline-danger px-4">
          <i class="bi bi-trash me-1"></i> Delete
        </button>
      </div>

      <!-- Edit Form -->
      <form id="profileForm" class="mt-4 text-start d-none">
        <div class="mb-3">
          <label class="form-label text-warning">Email</label>
          <input type="email" class="form-control" id="email">
        </div>
        <div class="mb-3">
          <label class="form-label text-warning">Phone</label>
          <input type="text" class="form-control" id="phone">
        </div>
        <div class="mb-3">
          <label class="form-label text-warning">Address</label>
          <input type="text" class="form-control" id="address">
        </div>
        <div class="mb-3">
          <label class="form-label text-warning">Panel Photo (Google Drive Link)</label>
          <input type="text" class="form-control" id="panelPhoto">
        </div>

        <div id="status" class="text-center small mt-2"></div>
        <div class="text-center mt-3">
          <button type="submit" class="btn btn-warning fw-bold px-4">üíæ Save Changes</button>
          <button type="button" id="cancelEdit" class="btn btn-secondary px-4 ms-2">Cancel</button>
        </div>
      </form>
    </div>
  </section>

  <script>
  const navLinks = document.getElementById("navLinks");
  const user = JSON.parse(localStorage.getItem("loggedUser"));

  if (user) {
    // Profile image
        let imgSrc = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
    if (user.panelPhoto && user.panelPhoto.includes("drive.google")) {
      const match = user.panelPhoto.match(/[-\w]{25,}/);
      if (match) imgSrc = `https://drive.google.com/uc?export=view&id=${match[0]}`;
    } else if (user.panelPhoto) {
      imgSrc = user.panelPhoto;
    }

    // Rebuild Navbar
    navLinks.innerHTML = `
      <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
      <li class="nav-item"><a class="nav-link" href="booking.html">Book Cleaning</a></li>
            <li class="nav-item"><a class="nav-link" href="My Bookings.html">My Bookings</a></li>

 ${user.isAdmin ? `<li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>             <li class="nav-item"><a class="nav-link " href="messages.html">Client Messages</a></li>
   <li class="nav-item"><a class="nav-link " href="users managment.html">Manage Users</a></li>
` : ""}  
      <li class="nav-item"><a class="nav-link" href="about.html"">How are We</a></li>


      <li class="nav-item dropdown ms-3">
        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown"
           role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="${imgSrc}" alt="User" class="rounded-circle me-2" style="width:35px; height:35px; object-fit:cover;">
          <span class="fw-bold text-warning">${user.fullName.split(" ")[0]}</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end shadow">
          <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
        </ul>
      </li>
    `;

    // Logout function
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("loggedUser");
      window.location.href = "login.html";
    });
  } else {
    // If not logged in, show default nav
    navLinks.innerHTML = `
      <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
      <li class="nav-item"><a class="nav-link" href="register.html">Register</a></li>
      <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
    `;
  }
</script>


  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBGSfwSqmK239i6CMP5mIItp_Xj-mwYV2I",
      authDomain: "solar-cleaning-website.firebaseapp.com",
      databaseURL: "https://solar-cleaning-website-default-rtdb.firebaseio.com",
      projectId: "solar-cleaning-website",
      storageBucket: "solar-cleaning-website.appspot.com",
      messagingSenderId: "454039844879",
      appId: "1:454039844879:web:8051aac69c8ac7baf50b7a",
      measurementId: "G-THCL9Q4WYX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // const user = JSON.parse(localStorage.getItem("loggedUser"));
    if (!user) window.location.href = "login.html";

    const usernameKey = user.username || user.fullName.toLowerCase().replace(/\s+/g, "_");

    const displayName = document.getElementById("displayName");
    const usernameDisplay = document.getElementById("usernameDisplay");
    const displayEmail = document.getElementById("displayEmail");
    const displayAddress = document.getElementById("displayAddress");
    const displayPhoto = document.getElementById("displayPhoto");
    const displayPhone = document.getElementById("displayPhone");
    const profileImage = document.getElementById("profileImage");
    const profileForm = document.getElementById("profileForm");
    const editToggle = document.getElementById("editToggle");
    const cancelEdit = document.getElementById("cancelEdit");
    const status = document.getElementById("status");

    async function loadUserData() {
      const snapshot = await get(ref(db, `users/${usernameKey}`));
      if (snapshot.exists()) {
        const data = snapshot.val();

        displayName.textContent = data.fullName || "No Name";
        usernameDisplay.textContent = usernameKey;
        displayEmail.textContent = data.email || "‚Äî";
        displayPhone.textContent = data.phone || "‚Äî";
        displayAddress.textContent = data.address || "‚Äî";
        displayPhoto.href = data.panelPhoto || "#";
        displayPhoto.textContent = data.panelPhoto ? "View Photo" : "Not Provided";

        if (data.panelPhoto && data.panelPhoto.includes("drive.google")) {
          const id = data.panelPhoto.match(/[-\w]{25,}/);
          profileImage.src = id ? `https://drive.google.com/uc?export=view&id=${id[0]}` : data.panelPhoto;
        } else {
          profileImage.src = data.panelPhoto || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        }

        document.getElementById("email").value = data.email || "";
        document.getElementById("phone").value = data.phone || "";
        document.getElementById("address").value = data.address || "";
        document.getElementById("panelPhoto").value = data.panelPhoto || "";
      }
    }

    window.addEventListener("DOMContentLoaded", loadUserData);

    editToggle.addEventListener("click", () => profileForm.classList.remove("d-none"));
    cancelEdit.addEventListener("click", () => profileForm.classList.add("d-none"));

    profileForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const updatedUser = {
        ...user,
        email: document.getElementById("email").value.trim(),
        phone: document.getElementById("phone").value.trim(),
        address: document.getElementById("address").value.trim(),
        panelPhoto: document.getElementById("panelPhoto").value.trim()
      };

      await set(ref(db, `users/${usernameKey}`), updatedUser);
      localStorage.setItem("loggedUser", JSON.stringify(updatedUser));
      status.textContent = "‚úÖ Profile updated!";
      status.className = "text-success text-center fw-bold";
      await loadUserData();
      setTimeout(() => profileForm.classList.add("d-none"), 1200);
    });

    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (confirm("‚ö†Ô∏è Delete your account permanently?")) {
        await remove(ref(db, `users/${usernameKey}`));
        localStorage.removeItem("loggedUser");
        alert("‚úÖ Account deleted.");
        window.location.href = "register.html";
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>