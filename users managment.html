<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Manage Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
          background: linear-gradient(135deg, #00416A 0%, #E4E5E6 100%);
      font-family: "Poppins", sans-serif;
      min-height: 80vh;

    }
    .table-container { margin-top: 100px; }
    .badge-admin { background-color: #ffc107; color: #000; }
  </style>
  <link rel="stylesheet" href="css/style.css">
</head>

<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold fs-4" href="index.html">
      <i class="bi bi-sun me-2 text-warning"></i> EcoShine
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto text-center align-items-center" id="navLinks"></ul>
    </div>
  </div>
</nav>

<!-- Users Table -->
<div class="container table-container">
  <h2 class="text-warning mb-4"><i class="bi bi-people me-2"></i>Manage Users</h2>
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle shadow-sm">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Full Name</th>
          <th>Username</th>
          <th>Email</th>
          <!-- <th>Phone</th> -->
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTable"></tbody>
    </table>
  </div>
</div>

<!-- Scripts -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBGSfwSqmK239i6CMP5mIItp_Xj-mwYV2I",
    authDomain: "solar-cleaning-website.firebaseapp.com",
    databaseURL: "https://solar-cleaning-website-default-rtdb.firebaseio.com",
    projectId: "solar-cleaning-website",
    storageBucket: "solar-cleaning-website.appspot.com",
    messagingSenderId: "454039844879",
    appId: "1:454039844879:web:8051aac69c8ac7baf50b7a",
    measurementId: "G-THCL9Q4WYX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const navLinks = document.getElementById("navLinks");
  const user = JSON.parse(localStorage.getItem("loggedUser"));

  // ‚úÖ Admin check
  if (!user || !user.isAdmin) {
    alert("‚ùå Access Denied! Admins only.");
    window.location.href = "login.html";
  }

  // ‚úÖ Build Navbar
  let imgSrc = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
  if (user.panelPhoto && user.panelPhoto.includes("drive.google")) {
    const match = user.panelPhoto.match(/[-\\w]{25,}/);
    if (match) imgSrc = `https://drive.google.com/uc?export=view&id=${match[0]}`;
  } else if (user.panelPhoto) {
    imgSrc = user.panelPhoto;
  }

    // Rebuild Navbar
    navLinks.innerHTML = `
      <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
      <li class="nav-item"><a class="nav-link" href="booking.html">Book Cleaning</a></li>
      <li class="nav-item"><a class="nav-link" href="My Bookings.html">My Bookings</a></li>
 
 ${user.isAdmin ? `<li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>           
   <li class="nav-item"><a class="nav-link " href="messages.html">Client Messages</a></li>
   <li class="nav-item"><a class="nav-link " href="users managment.html">Manage Users</a></li>
 ` : ""}  
       <li class="nav-item"><a class="nav-link" href="about.html"">How are We</a></li>
    <li class="nav-item dropdown ms-3">
        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown"
           role="button" data-bs-toggle="dropdown" aria-expanded="false">
          <img src="${imgSrc}" alt="User" class="rounded-circle me-2" style="width:35px; height:35px; object-fit:cover;">
          <span class="fw-bold text-warning">${user.fullName.split(" ")[0]}</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-end shadow">
          <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person me-2"></i>Profile</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
        </ul>
      </li>
    `;
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("loggedUser");
    window.location.href = "login.html";
  });

  // ‚úÖ Load all users
  const usersTable = document.getElementById("usersTable");
  const usersRef = ref(db, "users");

  onValue(usersRef, snapshot => {
    usersTable.innerHTML = "";
    const data = snapshot.val();
    if (!data) {
      usersTable.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No users found</td></tr>`;
      return;
    }

    let index = 1;
    for (const key in data) {
      const u = data[key];
      const isAdmin = u.isAdmin ? true : false;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index++}</td>
        <td>${u.fullName || "No Name"}</td>
        <td>${key}</td>
        <td>${u.email || "‚Äî"}</td> 
        <td>${isAdmin ? '<span class="badge badge-admin">Admin</span>' : '<span class="badge bg-secondary">User</span>'}</td>
        <td>
          ${isAdmin
            ? `<button class="btn btn-warning btn-sm m-2 demote" data-key="${key}"><i class="bi bi-arrow-down-circle"></i> Remove Admin</button>`
            : `<button class="btn btn-success btn-sm m-2 promote" data-key="${key}"><i class="bi bi-arrow-up-circle"></i> Make Admin</button>`
          }
          <button class="btn btn-danger btn-sm delete" data-key="${key}"><i class="bi bi-trash"></i> Delete</button>
        </td>
      `;
      usersTable.appendChild(tr);
    }

    // ‚úÖ Add button listeners
    document.querySelectorAll(".promote").forEach(btn => {
      btn.addEventListener("click", async e => {
        const key = e.target.closest("button").dataset.key;
        await update(ref(db, `users/${key}`), { isAdmin: true });
        alert("‚úÖ User promoted to Admin!");
      });
    });

    document.querySelectorAll(".demote").forEach(btn => {
      btn.addEventListener("click", async e => {
        const key = e.target.closest("button").dataset.key;
        await update(ref(db, `users/${key}`), { isAdmin: false });
        alert("‚ö†Ô∏è Admin rights removed!");
      });
    });

    document.querySelectorAll(".delete").forEach(btn => {
      btn.addEventListener("click", async e => {
        const key = e.target.closest("button").dataset.key;
        if (confirm("Are you sure you want to delete this account?")) {
          await remove(ref(db, `users/${key}`));
          alert("üóëÔ∏è User deleted successfully!");
        }
      });
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
